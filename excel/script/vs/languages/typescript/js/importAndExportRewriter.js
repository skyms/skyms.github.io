/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};define("vs/languages/typescript/js/importAndExportRewriter",["require","exports","vs/base/strings","vs/base/paths","vs/languages/typescript/lib/typescriptServices","vs/base/collections"],function(e,t,r,n,o,i){var s=function(){function e(e,t){this.offset=e,this.length=t}return e}();t.Node=s;var a=function(e){function t(){e.apply(this,arguments),this.items=[]}return __extends(t,e),t}(s);t.List=a;var l=function(e){function t(t,r,n){e.call(this,t,r),this.scope=n,this.requireStatements=[],this.exportsDotExpressions=[]}return __extends(t,e),t}(s);t.DefineNode=l;var c=function(e){function t(t,r,n){e.call(this,t,r),this.name=n}return __extends(t,e),t}(s);t.CallbackParameter=c;var u=function(e){function t(t,r,o){e.call(this,t,r),this._path=o;var i,s=/('|")(.+)\1/.exec(this._path);s&&(i=n.extname(s[2]))&&(this._path=""+s[1]+s[2].substring(0,s[2].length-i.length)+s[1])}return __extends(t,e),Object.defineProperty(t.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),t}(s);t.DependencyNode=u;var d=function(e){function t(t,r,n,o){e.call(this,t,r,o),this.name=n}return __extends(t,e),t}(u);t.RequireStatement=d;var h=function(e){function t(t,r,n){e.call(this,t,r),this.name=n}return __extends(t,e),t}(s);t.ExportsExpression=h;var p=function(e){function t(t,r){e.call(this,t,r)}return __extends(t,e),t}(s);t.GlobalExportsExpression=p;var m=function(e){function t(t){e.call(this,0,0),this.name=t}return __extends(t,e),t}(s);t.NamedExportExpresson=m;var f=function(){function e(){}return e.prototype.computeEdits=function(e){e.newInsert("declare var exports:any; declare var module:any; declare var require:any;\n"),this._context=e,this._currentScopeId=0,this._currentNode=null,this._bucket=[],this._variableNames=new v,this._visitNode(this._context.sourceFile);for(var t=!1,r=0,n=this._bucket.length;n>r;r++){var o=this._bucket[r];o instanceof l&&!t&&0===o.scope?(this._translateDefineNode(o),t=!0):o instanceof p?this._translateGlobalExportsExpression(o):o instanceof h?this._translateExportsExpression(o):o instanceof m?this._translateNamedExportExpresson(o):o instanceof d&&this._translateRequireStatement(o)}},Object.defineProperty(e.prototype,"nodes",{get:function(){return this._bucket},enumerable:!0,configurable:!0}),e.prototype._untilParent=function(e,t){for(var r=e.parent;r&&r.kind!==t;)r=r.parent;return r},e.prototype._store=function(e){this._currentNode?e instanceof d?this._currentNode.requireStatements.push(e):e instanceof h&&this._currentNode.exportsDotExpressions.push(e):this._bucket.push(e)},e.prototype.visitBinaryExpression=function(e){var t;if(e.operator===o.SyntaxKind.EqualsToken&&e.parent.kind===o.SyntaxKind.ExpressionStatement){var r,n;if(g.isIdentifier(e.left,"exports"))r=e.left.getStart(),n=e.left.getEnd(),t=new p(r,n-r);else if(e.left.kind===o.SyntaxKind.PropertyAccessExpression){var i=e.left,s=i.name.text;if(i.expression.kind===o.SyntaxKind.Identifier){var a=o.getTextOfNode(i.expression);"exports"===a?t=new h(i.getStart(),i.getWidth(),s):"module"===a&&"exports"===s&&(t=new p(i.getStart(),i.getWidth()))}else if(i.expression.kind===o.SyntaxKind.PropertyAccessExpression){var l=i.expression;g.isIdentifier(l.expression,"module")&&g.isIdentifier(l.name,"exports")&&(t=new h(i.getStart(),i.getWidth(),s))}}t&&o.getContainingFunction(e)&&!g.getContainingAmdDefineCall(e)&&(t instanceof h?t=new m(t.name):t instanceof p&&(t=void 0))}t?this._store(t):this._visitNode(e)},e.prototype.visitCallExpression=function(t){if(g.isIdentifier(t.expression,e._Require)){var r=t.arguments;if(g.isPath(r,o.SyntaxKind.StringLiteral)){var n,i=this._untilParent(t,o.SyntaxKind.VariableDeclaration);i&&(n=i.name.text),this._store(new d(o.getTokenPosOfNode(t),t.getWidth(),n,o.getTextOfNode(r[0])))}}else if(g.isIdentifier(t.expression,e._Define)&&(this._currentNode=new l(o.getTokenPosOfNode(t),t.getWidth(),this._currentScopeId),r=t.arguments,g.isPath(r,o.SyntaxKind.ObjectLiteralExpression)?this._currentNode.objectLiteral=new s(o.getTokenPosOfNode(r[0]),r[0].getWidth()):g.isPath(r,o.SyntaxKind.FunctionExpression)?this._fillInParametersAndBody(r[0],this._currentNode):g.isPath(r,o.SyntaxKind.ArrayLiteralExpression,o.SyntaxKind.FunctionExpression)?(this._fillInDependencies(r[0],this._currentNode),this._fillInParametersAndBody(r[1],this._currentNode)):g.isPath(r,o.SyntaxKind.StringLiteral,o.SyntaxKind.ArrayLiteralExpression,o.SyntaxKind.FunctionExpression)?(this._currentNode.identifier=r[0].text,this._fillInDependencies(r[1],this._currentNode),this._fillInParametersAndBody(r[2],this._currentNode)):this._currentNode=null,this._currentNode))return this._bucket.push(this._currentNode),this._visitNode(t),this._currentNode=null,void 0;this._visitNode(t)},e.prototype._fillInDependencies=function(e,t){t.dependencyArray=new a(o.getTokenPosOfNode(e),e.getWidth());for(var r=0,n=e.elements.length;n>r;r++){var i=e.elements[r];t.dependencyArray.items.push(new u(o.getTokenPosOfNode(i),i.getWidth(),o.getTextOfNode(i)))}},e.prototype._fillInParametersAndBody=function(e,t){var r,n;r=e.parameters.pos,n=e.parameters.end,t.callbackParameters=new a(r,n-r);for(var i=e.parameters,l=0,u=i.length;u>l;l++){var d=i[l];t.callbackParameters.items.push(new c(o.getTokenPosOfNode(d),d.getWidth(),o.getTextOfNode(d)))}r=e.body.getStart()+1,n=e.body.getEnd()-1,t.callbackBody=new s(r,n-r)},e.prototype._visitNode=function(e){var t=this;o.forEachChild(e,function(e){switch(e.kind){case o.SyntaxKind.BinaryExpression:t.visitBinaryExpression(e);break;case o.SyntaxKind.CallExpression:t.visitCallExpression(e);break;case o.SyntaxKind.FunctionDeclaration:case o.SyntaxKind.FunctionExpression:case o.SyntaxKind.ArrowFunction:t._currentScopeId+=1,t._visitNode(e),t._currentScopeId-=1;break;default:t._visitNode(e)}})},e.prototype._translateRequireStatement=function(e){var t=this._variableNames.next(e.name||e.path);this._context.newInsert(r.format("import {0} = require({1});\n",t,e.path)),this._context.newReplace(e.offset,e.length,t)},e.prototype._translateGlobalExportsExpression=function(e){var t=this._variableNames.next();this._context.newReplace(e.offset,e.length,r.format("var {0}",t)),this._context.newAppend(r.format("\nexport = {0};",t))},e.prototype._translateExportsExpression=function(e){this._context.newReplace(e.offset,e.length-e.name.length,"export var ")},e.prototype._translateNamedExportExpresson=function(e){this._context.newAppend("export var "+e.name+":any;\n")},e.prototype._translateDefineNode=function(t){if(t.objectLiteral)this._context.newInsert(e._DeclareWithLiteral);else{if(t.dependencyArray)for(var n=0,o=t.callbackParameters.items.length;o>n;n++){var i=t.callbackParameters.items[n],s=t.dependencyArray.items[n];if(!e._SpecialCallbackParams.hasOwnProperty(i.name)&&s){var a=this._variableNames.next();this._context.newInsert(r.format("import {0} = require({1});\n",a,s.path)),this._context.newInsert(i.offset+i.length,r.format(":typeof {0}",a))}}for(var l=[],n=0,o=t.requireStatements.length;o>n;n++){var c=t.requireStatements[n],u=this._variableNames.next(),d=this._variableNames.next();this._context.newInsert(r.format("import {0} = require({1});\n",u,c.path)),this._context.newReplace(c.offset,c.length,d),l.push(r.format("{0}:typeof {1}",d,u))}l.length>0&&this._context.newInsert(t.callbackParameters.offset+t.callbackParameters.length,r.format("{0}{1}",t.callbackParameters.items.length>0?",":"",l.join(",")));for(var h=[],n=0,o=t.exportsDotExpressions.length;o>n;n++){var p=t.exportsDotExpressions[n],m=this._variableNames.next();this._context.newReplace(p.offset,p.length,r.format("var {0}",m)),h.push(p.name),h.push(":"),h.push(m),h.push(",")}h.length>0&&(h.pop(),this._context.newInsert(t.callbackBody.offset+t.callbackBody.length,r.format("return {{0}};",h.join(r.empty))));var f=t.identifier?"id,":r.empty,g=t.dependencyArray?"dep,":r.empty,v=t.callbackParameters.items.map(function(e){return e.name}).concat(t.requireStatements.map(function(e,t){return r.format("_p{0}",t)})).join(",");this._context.newInsert(r.format(e._DeclareTemplate,f,g,v))}var b=this._variableNames.next();this._context.newInsert(t.offset,r.format("var {0} = ",b)),this._context.newAppend(r.format("\nexport = {0};",b))},e._SpecialCallbackParams={exports:!0,module:!0,require:!0},e._DeclareWithLiteral="declare function define<T>(literal:T):T;\n",e._DeclareTemplate="declare function define<T>({0}{1}callback:({2})=>T):T;\n",e._Define="define",e._Require="require",e}();t.ImportsAndExportsCollector=f;var g,v=function(){function e(){this._counter=0,this._proposalToName={},this._allNames={}}return e.prototype.next=function(t){if(!t)return r.format("_var_{0}",this._counter++);var o=i.lookup(this._proposalToName,t);if(o)return o;if(o=t.replace(/["']/g,r.empty),o=n.basename(o),o=o.replace(e._RegExp,r.empty),0===o.length)return this.next();o=o.split(r.empty).join(e._SpecialChar),o+=e._SpecialChar;for(var s=o,a=1;i.contains(this._allNames,o);a++)o=s+a;return this._allNames[o]=!0,this._proposalToName[t]=o,o},e.prototype.allocateIfFree=function(e){return i.contains(this._allNames,e)?!1:(this._allNames[e]=!0,!0)},e.prototype.reset=function(){this._counter=0,this._proposalToName={},this._allNames={}},e._RegExp=/[^A-Za-z_$]/g,e._SpecialChar="Ì²",e}();!function(e){function t(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(t.length!==e.length)return!1;for(var n=0,o=t.length;o>n;n++)if(e[n].kind!==t[n])return!1;return!0}function r(e,t){return e.kind===o.SyntaxKind.Identifier&&o.getTextOfNode(e)===t}function n(e){for(;;)if(e=e.parent,!e||i(e))return e}function i(t){if(t.kind!==o.SyntaxKind.CallExpression)return!1;var n=t;return r(n.expression,"define")?e.isPath(n.arguments,o.SyntaxKind.ObjectLiteralExpression)?!0:e.isPath(n.arguments,o.SyntaxKind.FunctionExpression)?!0:e.isPath(n.arguments,o.SyntaxKind.ArrayLiteralExpression,o.SyntaxKind.FunctionExpression)?!0:e.isPath(n.arguments,o.SyntaxKind.StringLiteral,o.SyntaxKind.ArrayLiteralExpression,o.SyntaxKind.FunctionExpression)?!0:!1:!1}e.isPath=t,e.isIdentifier=r,e.getContainingAmdDefineCall=n,e.isAmdDefineCall=i}(g||(g={}))});