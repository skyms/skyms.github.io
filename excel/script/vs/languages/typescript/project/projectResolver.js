/*---------------------------------------------------------
 * Copyright (C) Microsoft Corporation. All rights reserved.
 *--------------------------------------------------------*/
"use strict";define("vs/base/db/indexeddb",["require","exports","vs/base/types","vs/base/lib/winjs.base","vs/base/errors"],function(e,t,n,r,o){function i(){return"undefined"!=typeof indexedDB}function s(e,t,n){return new r.TPromise(function(r,o){var i;i="undefined"!=typeof t?indexedDB.open(e,t):indexedDB.open(e),i.onerror=function(e){return o(e)},i.onsuccess=function(e){return r(new u(e.target.result))},i.onupgradeneeded=function(e){if(!n)return o(e);var t=e.target.result;n({createDataStore:function(e){var n=t.createObjectStore(e.name,{keyPath:e.keyPath,autoIncrement:e.autoIncrement});e.index&&e.index.forEach(function(e){return n.createIndex(e.name,e.keyPath,e.options)})},deleteDataStore:function(e){t.deleteObjectStore(e)}},t)}})}function a(e){return new r.TPromise(function(t,n){e.onsuccess=function(){t(e)},e.onerror=function(t){n(e.error||t)}})}t.canBeUsed=i,function(e){e[e.ReadOnly=0]="ReadOnly",e[e.ReadWrite=1]="ReadWrite",e[e.VersionChange=2]="VersionChange"}(t.TransactionMode||(t.TransactionMode={}));var l,l=t.TransactionMode;!function(e){function t(t){return e[t]?e[t].toLowerCase():null}e.toString=t}(l=t.TransactionMode||(t.TransactionMode={})),function(e){e[e.Next=0]="Next",e[e.NextUnique=1]="NextUnique",e[e.Prev=2]="Prev",e[e.PrevUnique=3]="PrevUnique"}(t.Direction||(t.Direction={}));var c,c=t.Direction;!function(e){function t(t){return e[t]?e[t].toLowerCase():null}e.toString=t}(c=t.Direction||(t.Direction={})),t.openDatabase=s;var u=function(){function e(e){this._db=e}return Object.defineProperty(e.prototype,"db",{get:function(){return this._db},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this._db.close()},e.prototype.createTransaction=function(e,t){return"undefined"!=typeof t?this._db.transaction(e,l.toString(t)):this._db.transaction(e)},e.prototype.objectStore=function(e){return this._db.objectStoreNames.contains(e)?new d(e,this):null},e}();t.Database=u;var d=function(){function e(e,t){this._name=e,this._database=t}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"store",{get:function(){return this._database.db.transaction(this._name).objectStore(this._name)},enumerable:!0,configurable:!0}),e.prototype.executeTransaction=function(e,t){var n=this;return new r.TPromise(function(r,i){var s,a;try{s=n._database.db.transaction(n._name,l.toString(e))}catch(c){return"InvalidStateError"===c.name&&(c=o.canceled()),i(c)}s.onerror=function(e){return i(e.target.error)},s.oncomplete=function(){return r(a)},s.onabort=function(){return i(o.canceled())};try{a=t(s.objectStore(n._name),s)}catch(c){s.abort(),i(c)}})},e.prototype.openCursor=function(e,t,n,r){return p.openCursor(this,null,e,t,n,r)},e.prototype.openIndexCursor=function(e,t,n,r,o){var i=this;return this.executeTransaction(t,function(){return p.openCursor(i,e,t,n,r,o)}).then(function(e){return e})},e.prototype.get=function(e){return this.executeTransaction(l.ReadOnly,function(t){return a(t.get(e))}).then(function(e){return e}).then(function(e){return e.result})},e}();t.ObjectStore=d;var p;!function(e){function t(e,t,o,i,s,a){var l,u=c.Next;return n.isFunction(i)?a=i:n.isFunction(s)?(l=i,a=s):(l=i,u=s),new r.TPromise(function(n,r){var i,s=[];e.executeTransaction(o,function(e){var n;n=t?e.index(t).openCursor(l,c.toString(u)):e.openCursor(l,c.toString(u)),n.onsuccess=function(t){var n=t.target;n.result&&s.push(a(n.result.value,n.result,e))},n.onerror=function(e){return i=e}}).then(function(){i?r(i):n(s)},r)})}e.openCursor=t}(p||(p={}))}),define("vs/languages/typescript/typescript",["require","exports","vs/platform/platform"],function(e,t,n){var r;!function(e){e.ResourceSetChanged="typescript.resourceSetChanged"}(r=t.Events||(t.Events={}));var o;!function(e){function t(e){o=e}function r(){return o}e.Identifier="typescript",n.Registry.add(e.Identifier,e);var o;e.setProjectResolver=t,e.getProjectResolver=r}(o=t.Extensions||(t.Extensions={}))}),define("vs/base/trie",["require","exports","vs/base/collections","vs/base/assert"],function(e,t,n,r){function o(e,t){void 0===t&&(t=m);var r,o;return r={_key:null,_parent:null,_children:{},parent:function(){return null},children:function(e){return void 0===e&&(e=!1),l(this,e)}},o={insert:function(e,n){return i(r,t(e),n)},lookUp:function(e,n){return void 0===n&&(n=!1),s(r,t(e),n)},roots:function(){return l(r,!1)},values:function(){return c(r)},fringe:function(){return u(r)},remove:function(e){return d(e)},forEach:function(e){return p(r,e)}},"undefined"!=typeof e&&n.forEach(e,function(e){o.insert(e.key,e.value)}),o}function i(e,t,n){for(var r=0,o=t.length,i=e;o>r&&(i=e._children[t[r]]);)e=i,r+=1;for(;o>r;)i={_key:t[r],_parent:e,_children:{},parent:function(){return a(this)},children:function(e){return void 0===e&&(e=!1),l(this,e)}},e._children[t[r]]=i,e=i,r+=1;return i.element=n,i}function s(e,t,n){for(var r=0,o=t.length,i=e,s=void 0!==i.element?i:void 0;o>r&&(i=e._children[t[r]]);)e=i,r+=1,void 0!==i.element&&(s=i);return i&&void 0!==i.element?i:n&&void 0!==s?s:null}function a(e){for(;e._parent;){if("undefined"!=typeof e._parent.element)return e._parent;e=e._parent}return null}function l(e,t){for(var r=[],o=n.values(e._children);o.length>0;)e=o.shift(),void 0!==e.element&&r.push(e),(t||void 0===e.element)&&o.push.apply(o,n.values(e._children));return r}function c(e){for(var t=[],r=[e];r.length>0;)e=r.pop(),void 0!==e.element&&t.push(e.element),n.forEach(e._children,function(e){r.push(e.value)});return t}function u(e){for(var t=[e],o=[];t.length>0;){var i=t.pop(),s=t.length;n.forEach(i._children,function(e){t.push(e.value)}),s===t.length&&null!==i._key&&(r.ok("undefined"!=typeof i.element),o.push(i))}return o}function d(e){return e._parent?e._parent._children[e._key]!==e?!1:(delete e._parent._children[e._key],"undefined"==typeof e._parent.element&&h(e._parent._children)&&d(e._parent),!0):!1}function p(e,t){n.forEach(e._children,function(e){void 0!==e.value.element&&t(e.value),p(e.value,t)})}function h(e){if(!e)return!0;for(var t in e)if(f.call(e,t))return!1;return!0}var m=function(e){return e.split("")};t.newTrie=o;var f=Object.prototype.hasOwnProperty});var __extends=this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);n.prototype=t.prototype,e.prototype=new n};define("vs/languages/typescript/project/projectResolver",["require","exports","vs/base/env","vs/base/hash","vs/base/strings","vs/base/paths","vs/base/errors","vs/base/lifecycle","vs/base/collections","vs/base/db/indexeddb","vs/base/lib/winjs.base","vs/platform/services","vs/languages/typescript/typescript","vs/base/trie"],function(e,t,n,r,o,i,s,a,l,c,u,d,p,h){var m;!function(e){function t(e){return"monaco_"+r.computeMurmur2StringHashCode(e)}function n(t,n){return c.openDatabase(t,1,function(t,n){for(var r=0,o=n.objectStoreNames.length;o>r;r++)t.deleteDataStore(n.objectStoreNames.item(r));t.createDataStore({name:e.storeName,keyPath:e.keyPath,index:[e.workspaceIndexOptions]})}).then(function(t){return n.push(t),t.objectStore(e.storeName)},function(){return null})}e.databaseName=t,e.keyPath="workspaceAbsolutePath",e.storeName="cache",e.workspaceIndexOptions={name:"workspaceName",keyPath:"workspaceName",options:{unique:!1}},e.openStore=n}(m||(m={}));var f=function(){function e(){}return e.prototype.resolve=function(){return null},e.Instance=new e,e}();t.NullProjectResolver=f;var g;!function(e){function t(e,t,n){for(var r=h.newTrie({},function(e){return e.split(i.sep).filter(function(e){return!o.isFalsyOrWhitespace(e)})}),s=h.newTrie(),a=!1,l=0,c=e.length;c>l;l++){var u=e[l];u&&u.workspacePath&&(u.type===d.Files.FileChangeType.DELETED?s.insert(u.workspacePath,u):(u.type===d.Files.FileChangeType.ADDED||u.type===d.Files.FileChangeType.UPDATED)&&r.insert(u.workspacePath,u))}s.roots().forEach(function(e){e.element.workspacePath&&(n(e.element.workspacePath),a=!0)});for(var p=r.roots();p.length>0;){var m=p.shift(),u=m.element;if(u.type===d.Files.FileChangeType.ADDED)u.workspacePath&&t(u.workspacePath);else if(u.type===d.Files.FileChangeType.UPDATED){var f=m.children(),c=f.length;if(0===c)continue;for(var g=0,l=0;c>l;l++)f[l].element.type===d.Files.FileChangeType.ADDED&&(g+=1);g>1?u.workspacePath&&(t(u.workspacePath),a=!0):p.push.apply(p,f)}}return a}e.minimize=t}(g=t.FileEventProcessing||(t.FileEventProcessing={}));var v=function(){function e(e,t){var n=this;this._fileService=e.fileService,this._eventService=e.eventService,this._options=t,this._disposables=[];var r=e.eventService.addListener(d.Files.EventType.FILE_CHANGES,function(e){var t=e.filterWorkspacePath(function(e,t){return!t.some(function(e){return".git"===e||"node_modules"===e})}).changes;g.minimize(t,function(e){return n._handleAdded(e)},function(e){return n._handleDelete(e)})&&n._eventService.emit(p.Events.ResourceSetChanged)});this._disposables.push({dispose:r}),this._pendingOperations=[u.TPromise.timeout(0).then(function(){return n._resolveStatsAndContents("/")})]}return e.prototype.dispose=function(){this._disposables=a.disposeAll(this._disposables)},e.prototype._handleDelete=function(e){this._pendingOperations.push(u.TPromise.as({removed:[e]}))},e.prototype._handleAdded=function(e){this._pendingOperations.push(this._resolveStatsAndContents(e))},e.prototype.resolve=function(){var e=this,t=this._pendingOperations.length;if(0===t)return u.TPromise.as({});if(this._resolverError)return u.TPromise.wrapError(this._resolverError);var n={added:[],removed:[],hasChanges:!1};return u.TPromise.join(this._pendingOperations.splice(0,t).map(function(t){return t.then(function(e){n.added.push.apply(n.added,e.added),n.removed.push.apply(n.removed,e.removed),n.hasChanges=n.hasChanges||e.hasChanges},function(t){if(!s.isPromiseCanceledError(t))throw e._resolverError=t,t})})).then(function(){return n},function(t){e._resolverError=t})},e.prototype._resolveStatsAndContents=function(e){var t=this;return this._fetchStats(e).then(function(n){return t._fetchContents(e,n)},function(e){if(404===e.status)return[];throw e}).then(function(e){return{added:e}})},e.prototype._fetchStats=function(e){return this._fileService.resolveFileStats(e,this._options.pattern)},e.prototype._fetchContents=function(e,t){return this._fileService.resolveContents(t.map(function(e){return e.path}))},e}(),b=function(){function e(){this._value=Object.create(null)}return e.prototype.change=function(){this._value=Object.create(null)},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),e}(),y=function(e){function t(t,n){e.call(this,t,n),this._workspaceName=t.contextService.getWorkspace()?t.contextService.getWorkspace().name:"__NO_WORKSPACE__",this._databaseName=m.databaseName(n.modeId),this._state=new b}return __extends(t,e),t.prototype._getObjectStore=function(){return this._objectStorePromise||(this._objectStorePromise=m.openStore(this._databaseName,this._disposables)),this._objectStorePromise},t.prototype._handleDelete=function(t){var n=this;this._pendingOperations.push(this._getObjectStore().then(function(e){return e?e.openIndexCursor(m.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(n._workspaceName),function(e,r,o){i.isEqualOrParent(e.content.path,t)&&(o.delete(e.workspaceAbsolutePath),n._state.change()),r.continue()}):void 0})),e.prototype._handleDelete.call(this,t)},t.prototype._resolveStatsAndContents=function(t){var n=this,r=this._state.value;return e.prototype._resolveStatsAndContents.call(this,t).then(function(e){return e.hasChanges=r!==n._state.value,e})},t.prototype._fetchContents=function(t,n){var r=this;return this._getObjectStore().then(function(o){return o?r._doFetchContents(o,t,n).then(function(e){return e.persistedContents.concat(e.volatileContents)}):e.prototype._fetchContents.call(r,t,n)})},t.prototype._doFetchContents=function(t,n,r){var o=this,a=i.join(this._workspaceName,n),u={},p={volatileContents:[],persistedContents:[]};return r.forEach(function(e){var t=i.join(o._workspaceName,e.path);if(l.lookupOrInsert(u,t,e)!==e)throw new Error("path collision between two different stat objects. path: "+t)}),t.openIndexCursor(m.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(this._workspaceName),function(e,t,n){var r=l.lookup(u,e.workspaceAbsolutePath);i.isEqualOrParent(e.workspaceAbsolutePath,a)&&(r&&r.etag===e.content.etag&&d.Files.isIContent(e.content)?(delete u[e.workspaceAbsolutePath],p.persistedContents.push(e.content)):(n.delete(e.workspaceAbsolutePath),o._state.change())),t.continue()}).then(function(){return e.prototype._fetchContents.call(o,n,l.values(u))}).then(function(e){return t.executeTransaction(c.TransactionMode.ReadWrite,function(t){e.forEach(function(e){t.put({workspaceName:o._workspaceName,workspaceAbsolutePath:i.join(o._workspaceName,e.path),content:{resource:void 0,charset:e.charset,etag:e.etag,mime:e.mime,mtime:e.mtime,name:e.name,path:e.path,value:e.value}}),o._state.change(),p.persistedContents.push(e)})}).then(void 0,function(t){if(!s.isPromiseCanceledError(t))throw t;p.volatileContents=e})}).then(function(){return p})},t}(v),_=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype._doFetchContents=function(t,n,r){return e.prototype._doFetchContents.call(this,t,n,r).then(function(e){return e.persistedContents.length=0,e})},t}(y),w=function(){function e(e,t){this._delegate=e.fileService?c.canBeUsed()?n.browser.isFirefox?e.instantiationService.createInstance(y,t):e.instantiationService.createInstance(_,t):e.instantiationService.createInstance(v,t):f.Instance}return e.prototype.resolve=function(){return this._delegate.resolve()},e}();t.ProjectResolver=w;var T=function(){function e(e,t){this._disposables=[],this._workspaceName=e.contextService.getWorkspace()?e.contextService.getWorkspace().name:"__NO_WORKSPACE__",this._databaseName=m.databaseName(t)}return e.prototype.dispose=function(){this._disposables=a.disposeAll(this._disposables)},e.prototype.resolve=function(e){if(o.isFalsyOrWhitespace(this._workspaceName))return u.TPromise.as(null);var t=i.join(this._workspaceName,e);return this._getObjectStore().then(function(e){return e?e.get(t).then(function(e){return e?e.content:null}):null})},e.prototype.accept=function(e){var t,n=this;return new u.TPromise(function(r,o){n._getObjectStore().then(function(r){return r?r.openIndexCursor(m.workspaceIndexOptions.name,c.TransactionMode.ReadWrite,IDBKeyRange.only(n._workspaceName),function(n,r){e(n.content),t||r.continue()}):void 0}).then(function(){return r(null)},o)},function(){t=s.canceled()})},e.prototype._getObjectStore=function(){return this._objectStorePromise||(this._objectStorePromise=m.openStore(this._databaseName,this._disposables)),this._objectStorePromise},e}();t.DatabaseContentResolver=T});